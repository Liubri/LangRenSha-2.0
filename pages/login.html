<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="../playerGrid.css" />
    <link rel="stylesheet" href="../modal.css" />
    <link rel="stylesheet" href="../voteSummary.css" />
    <title>Werewolf</title>
  </head>
  <body>
    <div class="container">
      <h1>
        <i data-lucide="moon" class="icon" id="moon"></i>
        狼人杀 (Werewolf)
      </h1>
      <div class="player-inputs">
        <input type="text" id="playerName" placeholder="Enter your name" />
        <input type="text" placeholder="Enter Lobby ID" />
        <button class="create-lobby" onclick="createLobby()">
          <i data-lucide="users" class="icon"></i>
          Create Lobby
        </button>
        <button class="join-room" onclick="handleJoinRoom()">
          <i data-lucide="door-open" class="icon"></i>
          Join Room
        </button>
      </div>
    </div>

    <!-- Create a Lobby-->
    <label for="lobbyType">Select Lobby Type:</label>
    <select id="lobbyType">
      <option value="preconfigured">Preconfigured Lobby</option>
      <option value="custom">Custom Lobby</option>
    </select>

    <div id="preconfiguredLobbies" style="display: none">
      <label for="preconfiguredLobby">Choose a Preconfigured Lobby:</label>
      <select id="preconfiguredLobby">
        <option value="basic">
          Basic: 4 Werewolves, 4 Villagers, 1 Seer, 1 Witch
        </option>
        <option value="advanced">
          AdvancedTest: 1 Witch, 1 Seer, 1 Werewolf
        </option>
        <!-- Add more preconfigured setups as needed -->
      </select>
    </div>

    <div id="customLobby" style="display: none">
      <h3>Custom Lobby Setup</h3>
      <label for="werewolvesCount">Number of Werewolves:</label>
      <input type="number" id="werewolvesCount" min="0" max="10" />

      <label for="villagersCount">Number of Villagers:</label>
      <input type="number" id="villagersCount" min="0" max="10" />

      <label for="seer">Include Seer:</label>
      <input type="checkbox" id="seer" />

      <label for="witch">Include Witch:</label>
      <input type="checkbox" id="witch" />

      <label for="wolfBeauty">Include 狼美人:</label>
      <input type="checkbox" id="wolfBeauty" />

      <!-- Add more role configurations as necessary -->
    </div>

    <!--Player Grid-->
    <div class="player-grid" id="mainPlayerGrid">
      <!-- Player cards will be generated here -->
    </div>

    <!--Game Log and Action buttons-->
    <div class="game-info">
      <div class="card">
        <h2>Game Log</h2>
        <div class="game-log">
          <p>The game has started. Night falls on the village...</p>
        </div>
      </div>
      <div class="card">
        <h2>Actions</h2>
        <div id="action-buttons">
          <button class="action-btn save">
            <i data-lucide="beaker" class="icon"></i> Save Potion
          </button>
          <button class="action-btn poison">
            <i data-lucide="beaker" class="icon"></i> Poison Potion
          </button>
          <button class="action-btn" id="openVoteModal">Vote</button>
        </div>
      </div>
    </div>

    <div class="modal" id="actionModal">
      <h1 id="modalTitle">Action</h1>
      <div class="players-grid" id="playersGrid"></div>
      <div class="buttons-container">
        <button id="actionButton" class="action-button" disabled>
          Confirm Action
        </button>
        <button id="skipVote" class="action-button">Skip Vote</button>
      </div>
    </div>

    <!-- Voting Results-->
    <div id="voting-results" class="voteCard">
      <div class="card-header">
        <div class="card-title">
          <svg class="icon">
            <!-- SVG for Vote Icon -->
          </svg>
          Voting Results
        </div>
      </div>
      <div class="card-content">
        <div id="grouped-votes" class="grouped-votes"></div>
        <div id="skipped-votes" class="skipped-votes hidden"></div>
        <div class="summary"></div>
      </div>
    </div>

    <script src="../login.js"></script>
    <script src="../lobby.js"></script>
    <script>
      let voterMap = new Map();
      let groupedVotesMap = new Map();

      socket.on("sendVoteMap", (voteMap) => {
        // Populate voterMap with the received data
        voterMap = new Map(Object.entries(voteMap));
        console.log("Received voterMap:", voterMap);
        console.log("VoteMap Size: ", voterMap.size);

        // Reset groupedVotesMap before grouping
        groupedVotesMap = new Map();

        // Group votes
        for (const [voter, target] of voterMap) {
          if (target) {
            const targetId = target.id; // Use unique identifier
            if (!groupedVotesMap.has(targetId)) {
              groupedVotesMap.set(targetId, { target, voters: [] });
            }
            groupedVotesMap.get(targetId).voters.push(voter);
          }
        }

        console.log("Grouped Votes Map:", groupedVotesMap);

        // Render grouped votes (if needed)
        if (voterMap.size == 3) {
          renderGroupedVotes(groupedVotesMap);
        }
      });

      // Function to render grouped votes (optional)
      function renderGroupedVotes(groupedVotesMap) {
        const skippedVotes = [];
        const votingResults = [];
        const groupedVotesContainer = document.getElementById("grouped-votes");
        const skippedVotesContainer = document.getElementById("skipped-votes");

        // Clear previous content
        groupedVotesContainer.innerHTML = "";
        skippedVotesContainer.innerHTML = ""; // Clear skipped votes content

        // Group votes and separate skipped votes
        for (const [targetId, { target, voters }] of groupedVotesMap) {
          if (targetId === 0) {
            // If the targetId is 0, treat it as a skipped vote
            skippedVotes.push(...voters);
          } else {
            // Otherwise, create a div for grouped votes
            votingResults.push(...voters);
            const groupDiv = document.createElement("div");
            groupDiv.className = "vote-group";

            const title = document.createElement("h3");
            title.textContent = `Votes for ${target.name} (${voters.length})`;
            groupDiv.appendChild(title);

            voters.forEach((voter) => {
              const voterDiv = document.createElement("div");
              voterDiv.className = "vote-item";
              voterDiv.textContent = voter;
              groupDiv.appendChild(voterDiv);
            });

            groupedVotesContainer.appendChild(groupDiv);
          }
        }

        // Render skipped votes
        if (skippedVotes.length > 0) {
          skippedVotesContainer.classList.remove("hidden"); // Make sure skipped votes section is visible
          const title = document.createElement("h3");
          title.textContent = `Skipped Votes (${skippedVotes.length})`;
          skippedVotesContainer.appendChild(title);

          skippedVotes.forEach((voter) => {
            const skipItem = document.createElement("div");
            skipItem.className = "skipped-item";
            skipItem.textContent = voter;
            skippedVotesContainer.appendChild(skipItem);
          });
        }

        // Update the summary
        const summary = document.querySelector(".summary");
        summary.textContent = `Total Votes: ${votingResults.length} • Skipped: ${skippedVotes.length}`;
      }
    </script>
  </body>
</html>
